# GitLab CI/CD é…ç½®æ–‡ä»¶ - ä»£ç å¼€æºåˆ° GitHub
# åŠŸèƒ½: å®‰å…¨æ‰«æ + ä»£ç æµ‹è¯• + è‡ªåŠ¨é•œåƒåˆ° GitHub

stages:
  - security    # å®‰å…¨æ‰«æé˜¶æ®µ
  - test        # ä»£ç æµ‹è¯•é˜¶æ®µ
  - mirror      # é•œåƒåŒæ­¥é˜¶æ®µ

# ================================
# å®‰å…¨æ‰«ææ¨¡æ¿å¼•å…¥
# ================================
include:
  # å¯†é’¥æ£€æµ‹ - é˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²
  - template: Security/Secret-Detection.gitlab-ci.yml
  # å¼€æºåè®®æ‰«æ - ç¡®ä¿ä¾èµ–åŒ…åˆè§„
  - template: Security/License-Scanning.gitlab-ci.yml

# ================================
# å®‰å…¨æ‰«æä»»åŠ¡é…ç½®
# ================================

# è‡ªå®šä¹‰å¯†é’¥æ£€æµ‹è§„åˆ™
secret_detection:
  stage: security
  variables:
    # æ’é™¤æµ‹è¯•å’Œæ–‡æ¡£ç›®å½•
    SECRET_DETECTION_EXCLUDED_PATHS: 'tests/,docs/,examples/'
  artifacts:
    reports:
      secret_detection: gl-secret-detection-report.json
    expire_in: 1 week
  only:
    - merge_requests
    - master

# å¼€æºåè®®æ‰«æ
license_scanning:
  stage: security
  variables:
    # æ ¹æ®é¡¹ç›®ç±»å‹é…ç½®ä¾èµ–å®‰è£…å‘½ä»¤
    LICENSE_MANAGEMENT_SETUP_CMD: npm install  # Node.js é¡¹ç›®
    # å¦‚æœæ˜¯ Python é¡¹ç›®ï¼Œæ”¹ä¸º: pip install -r requirements.txt
  artifacts:
    reports:
      license_scanning: gl-license-scanning-report.json
    expire_in: 1 week
  only:
    - merge_requests
    - master

# ================================
# ä»£ç æµ‹è¯•ä»»åŠ¡
# ================================

# ä»£ç è´¨é‡æ£€æŸ¥å’Œå•å…ƒæµ‹è¯•
test:
  stage: test
  image: node:18-alpine  # ä½¿ç”¨ Node.js 18 ç¯å¢ƒï¼Œæ ¹æ®é¡¹ç›®éœ€è¦ä¿®æ”¹
  before_script:
    - echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
    - npm ci  # ä½¿ç”¨ ci å‘½ä»¤ç¡®ä¿ä¾èµ–ç‰ˆæœ¬ä¸€è‡´
  script:
    # ä»£ç é£æ ¼æ£€æŸ¥
    - echo "ğŸ” è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥..."
    - npm run lint || echo "âš ï¸ Lint æ£€æŸ¥æœªé€šè¿‡ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
    
    # å•å…ƒæµ‹è¯•
    - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
    - npm run test || echo "âš ï¸ æµ‹è¯•æœªé€šè¿‡ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
    
    # æ„å»ºæ£€æŸ¥ï¼ˆç¡®ä¿ä»£ç å¯ä»¥æˆåŠŸæ„å»ºï¼‰
    - echo "ğŸ”¨ æ£€æŸ¥æ„å»º..."
    - npm run build || echo "âš ï¸ æ„å»ºæœªé€šè¿‡ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/
  artifacts:
    reports:
      junit: junit.xml  # å¦‚æœæµ‹è¯•æ¡†æ¶æ”¯æŒ JUnit æ ¼å¼
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - merge_requests
    - master
  tags:
    - docker

# ================================
# é•œåƒåˆ° GitHub ä»»åŠ¡
# ================================

mirror_to_github:
  stage: mirror
  image: alpine/git:latest  # è½»é‡çº§ Git é•œåƒ
  
  # ä»…åœ¨ master åˆ†æ”¯æœ‰å˜æ›´æ—¶è§¦å‘
  only:
    - master
  
  before_script:
    - echo "ğŸš€ å‡†å¤‡åŒæ­¥ä»£ç åˆ° GitHub..."
    - echo "è§¦å‘ç”¨æˆ·: ${GITLAB_USER_LOGIN}"
    - echo "Commit SHA: ${CI_COMMIT_SHA}"
    - echo "Commit Message: ${CI_COMMIT_MESSAGE}"
  
  script:
    # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
    - git config --global user.name "GitLab Mirror Bot"
    - git config --global user.email "bot@gitlab.example.com"
    
    # è®°å½•åŒæ­¥å¼€å§‹æ—¶é—´
    - export SYNC_START_TIME=$(date '+%Y-%m-%d %H:%M:%S')
    - echo "åŒæ­¥å¼€å§‹æ—¶é—´: ${SYNC_START_TIME}"
    
    # åˆ›å»ºå®¡è®¡æ—¥å¿—
    - mkdir -p audit-logs
    - echo "========================================" > audit-logs/mirror-audit.log
    - echo "åŒæ­¥æ—¶é—´: ${SYNC_START_TIME}" >> audit-logs/mirror-audit.log
    - echo "è§¦å‘ç”¨æˆ·: ${GITLAB_USER_LOGIN}" >> audit-logs/mirror-audit.log
    - echo "Commit SHA: ${CI_COMMIT_SHA}" >> audit-logs/mirror-audit.log
    - echo "Commit Message: ${CI_COMMIT_MESSAGE}" >> audit-logs/mirror-audit.log
    - echo "Pipeline ID: ${CI_PIPELINE_ID}" >> audit-logs/mirror-audit.log
    - echo "Pipeline URL: ${CI_PIPELINE_URL}" >> audit-logs/mirror-audit.log
    - echo "----------------------------------------" >> audit-logs/mirror-audit.log
    
    # å…‹éš†å½“å‰ä»“åº“ï¼ˆbare å…‹éš†ï¼Œä¸åŒ…å«å·¥ä½œç›®å½•ï¼‰
    - echo "ğŸ“¥ å…‹éš† GitLab ä»“åº“..."
    - git clone --mirror https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git temp-repo
    - cd temp-repo
    
    # æ·»åŠ  GitHub è¿œç¨‹ä»“åº“
    - echo "ğŸ”— æ·»åŠ  GitHub è¿œç¨‹ä»“åº“..."
    - git remote add github https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/${GITHUB_USERNAME}/${GITHUB_REPO}.git
    
    # æ¨é€ master åˆ†æ”¯åˆ° GitHub çš„ main åˆ†æ”¯
    - echo "ğŸ“¤ æ¨é€ä»£ç åˆ° GitHub main åˆ†æ”¯..."
    - git push github refs/heads/master:refs/heads/main --force
    
    # åŒæ­¥æ‰€æœ‰æ ‡ç­¾
    - echo "ğŸ·ï¸  åŒæ­¥ Git æ ‡ç­¾..."
    - git push github --tags --force || echo "âš ï¸ æ ‡ç­¾æ¨é€å¤±è´¥æˆ–æ— æ ‡ç­¾"
    
    # è®°å½•åŒæ­¥ç»“æœ
    - export SYNC_END_TIME=$(date '+%Y-%m-%d %H:%M:%S')
    - echo "åŒæ­¥ç»“æŸæ—¶é—´: ${SYNC_END_TIME}" >> ../audit-logs/mirror-audit.log
    - echo "åŒæ­¥çŠ¶æ€: SUCCESS âœ…" >> ../audit-logs/mirror-audit.log
    - echo "GitHub ä»“åº“: https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}" >> ../audit-logs/mirror-audit.log
    - echo "========================================" >> ../audit-logs/mirror-audit.log
    
    # æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    - echo "âœ… ä»£ç å·²æˆåŠŸåŒæ­¥åˆ° GitHub!"
    - echo "ğŸ“ GitHub ä»“åº“åœ°å€: https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}"
    - echo "ğŸ” æŸ¥çœ‹ GitHub Commits: https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}/commits/main"
  
  after_script:
    # æ¸…ç†ä¸´æ—¶ä»“åº“
    - echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    - cd ..
    - rm -rf temp-repo
    - echo "æ¸…ç†å®Œæˆ"
  
  # ä¿å­˜å®¡è®¡æ—¥å¿—
  artifacts:
    paths:
      - audit-logs/mirror-audit.log
    expire_in: 1 year  # å®¡è®¡æ—¥å¿—ä¿ç•™ 1 å¹´
  
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0  # å®Œæ•´å…‹éš†ï¼ŒåŒ…å«æ‰€æœ‰å†å²è®°å½•
  
  tags:
    - docker
  
  # å¤±è´¥æ—¶é‡è¯•é…ç½®
  retry:
    max: 2  # æœ€å¤šé‡è¯• 2 æ¬¡
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ================================
# é€šçŸ¥ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
# ================================

# åŒæ­¥æˆåŠŸé€šçŸ¥
notify_success:
  stage: .post  # åœ¨æ‰€æœ‰é˜¶æ®µå®Œæˆåæ‰§è¡Œ
  image: curlimages/curl:latest
  script:
    - echo "ğŸ“¢ å‘é€æˆåŠŸé€šçŸ¥..."
    # å¦‚æœé…ç½®äº† Webhookï¼Œå¯ä»¥åœ¨è¿™é‡Œå‘é€é€šçŸ¥
    # ç¤ºä¾‹ï¼šå‘é€åˆ°é’‰é’‰/ä¼ä¸šå¾®ä¿¡
    # - |
    #   curl -X POST "${DINGTALK_WEBHOOK}" \
    #     -H 'Content-Type: application/json' \
    #     -d "{
    #       \"msgtype\": \"markdown\",
    #       \"markdown\": {
    #         \"title\": \"ä»£ç å¼€æºåŒæ­¥æˆåŠŸ\",
    #         \"text\": \"## ğŸ“¢ ä»£ç å¼€æºåŒæ­¥é€šçŸ¥\n\n**é¡¹ç›®**: ${CI_PROJECT_NAME}\n\n**åˆ†æ”¯**: master â†’ GitHub main\n\n**æäº¤è€…**: ${GITLAB_USER_LOGIN}\n\n**æäº¤ä¿¡æ¯**: ${CI_COMMIT_MESSAGE}\n\n**æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')\n\n**çŠ¶æ€**: âœ… åŒæ­¥æˆåŠŸ\n\n[æŸ¥çœ‹ GitHub ä»“åº“](https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO})\n\n[æŸ¥çœ‹ Pipeline](${CI_PIPELINE_URL})\"
    #       }
    #     }"
    - echo "é€šçŸ¥å·²å‘é€ï¼ˆå¦‚å·²é…ç½®ï¼‰"
  only:
    - master
  when: on_success
  allow_failure: true  # é€šçŸ¥å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹

# åŒæ­¥å¤±è´¥é€šçŸ¥
notify_failure:
  stage: .post
  image: curlimages/curl:latest
  script:
    - echo "âš ï¸ å‘é€å¤±è´¥é€šçŸ¥..."
    # å‘é€å¤±è´¥é€šçŸ¥åˆ°å›¢é˜Ÿ
    # - |
    #   curl -X POST "${DINGTALK_WEBHOOK}" \
    #     -H 'Content-Type: application/json' \
    #     -d "{
    #       \"msgtype\": \"markdown\",
    #       \"markdown\": {
    #         \"title\": \"ä»£ç å¼€æºåŒæ­¥å¤±è´¥\",
    #         \"text\": \"## âš ï¸ ä»£ç å¼€æºåŒæ­¥å¤±è´¥\n\n**é¡¹ç›®**: ${CI_PROJECT_NAME}\n\n**åˆ†æ”¯**: master\n\n**æäº¤è€…**: ${GITLAB_USER_LOGIN}\n\n**æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')\n\n**çŠ¶æ€**: âŒ åŒæ­¥å¤±è´¥\n\nè¯·æ£€æŸ¥ [Pipeline æ—¥å¿—](${CI_PIPELINE_URL})\"
    #       }
    #     }"
    - echo "å¤±è´¥é€šçŸ¥å·²å‘é€ï¼ˆå¦‚å·²é…ç½®ï¼‰"
  only:
    - master
  when: on_failure
  allow_failure: true

# ================================
# é…ç½®è¯´æ˜
# ================================

# éœ€è¦åœ¨ GitLab ä¸­é…ç½®ä»¥ä¸‹ CI/CD å˜é‡:
# Settings â†’ CI/CD â†’ Variables
# 
# | å˜é‡å            | å€¼                              | Protected | Masked | è¯´æ˜                |
# |-------------------|---------------------------------|-----------|--------|---------------------|
# | GITHUB_USERNAME   | your-github-username            | âœ…        | âŒ     | GitHub ç”¨æˆ·å       |
# | GITHUB_TOKEN      | ghp_xxxxxxxxxxxx                | âœ…        | âœ…     | GitHub PAT          |
# | GITHUB_REPO       | your-open-source-project        | âœ…        | âŒ     | GitHub ä»“åº“å       |
# | DINGTALK_WEBHOOK  | https://oapi.dingtalk.com/...   | âœ…        | âœ…     | é’‰é’‰ Webhook (å¯é€‰) |
#
# æ³¨æ„äº‹é¡¹:
# 1. ç¡®ä¿ GitHub Token å…·æœ‰ 'repo' æƒé™
# 2. æ‰€æœ‰å˜é‡éƒ½åº”æ ‡è®°ä¸º Protectedï¼Œæ•æ„Ÿä¿¡æ¯æ ‡è®°ä¸º Masked
# 3. æ ¹æ®é¡¹ç›®å®é™…æƒ…å†µä¿®æ”¹ test ä»»åŠ¡ä¸­çš„å‘½ä»¤ï¼ˆnpm/pip/maven ç­‰ï¼‰
# 4. å¦‚éœ€å¯ç”¨é€šçŸ¥ï¼Œå–æ¶ˆæ³¨é‡Š notify_success å’Œ notify_failure ä¸­çš„ curl å‘½ä»¤
# 5. å¦‚æœé¡¹ç›®æ²¡æœ‰æµ‹è¯•ï¼Œå¯ä»¥æ³¨é‡Šæ‰ test ä»»åŠ¡æˆ–ä¿®æ”¹ script å†…å®¹
